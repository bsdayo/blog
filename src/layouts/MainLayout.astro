---
import '@/styles/global.css'
import { ClientRouter } from 'astro:transitions'
import siteConfig from '@/site.config'

interface Props {
  title?: string
}

const title = Astro.props.title ? `${Astro.props.title} | ${siteConfig.title}` : siteConfig.title
---

<script is:inline>
  /**
   * @returns {'light' | 'dark'}
   */
  function _getTheme() {
    if (typeof localStorage !== 'undefined') {
      let theme = localStorage.getItem('theme')
      if (theme) return theme
    }
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }
  /**
   * @param {'light' | 'dark'} theme
   * @param {Document} target
   */
  function _setTheme(theme, target) {
    const doc = target ?? document
    doc.documentElement.classList[theme === 'dark' ? 'add' : 'remove']('dark')
    if (!target && typeof localStorage !== 'undefined') {
      localStorage.setItem('theme', theme)
    }
  }

  _setTheme(_getTheme())
</script>

<script>
  import { $currentTheme } from '@/utils/stores'

  $currentTheme.set(globalThis._getTheme())

  document.addEventListener('astro:before-swap', (event) => {
    const theme = globalThis._getTheme()
    $currentTheme.set(theme)
    globalThis._setTheme(theme, event.newDocument)
  })
</script>

<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ClientRouter />
  </head>
  <body class="m-0">
    <slot />
  </body>
</html>
